generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Club {
  id                 String           @id @default(uuid())
  name               String
  slug               String           @unique
  logoUrl            String?
  themeColor         String?          @default("#0080ff")
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  timezone           String           @default("America/Argentina/Buenos_Aires")
  currency           String           @default("ARS")
  openTime           String           @default("14:00")
  closeTime          String           @default("00:30")
  slotDuration       Int              @default(90)
  cancelHours        Int              @default(6)
  plan               String           @default("BASIC")
  subscriptionStatus String           @default("TRIAL")
  nextBillingDate    DateTime?
  maxCourts          Int              @default(2)
  maxUsers           Int              @default(3)
  hasKiosco          Boolean          @default(false)
  hasOnlinePayments  Boolean          @default(false)
  hasAdvancedReports Boolean          @default(false)
  allowCredit        Boolean          @default(true)
  hasCustomDomain    Boolean          @default(false)
  hasTournaments     Boolean          @default(false)
  bookings           Booking[]
  mpAlias            String?
  mpCvu              String?
  mpAccessToken      String? // Access Token de producción
  mpPublicKey        String? // Public Key (opcional, útil para frontend)
  bookingDeposit     Float            @default(0) // Monto de seña fijo por reserva
  
  // Platform Subscription
  mpPreapprovalId    String?          // ID de la suscripción en MercadoPago (SaaS)
  platformPlanId     String?
  platformPlan       PlatformPlan?    @relation(fields: [platformPlanId], references: [id])

  cashRegisters      CashRegister[]
  clients            Client[]
  courts             Court[]
  priceRules         PriceRule[]
  products           Product[]
  users              User[]
  auditLogs          AuditLog[]
  waitingList        WaitingList[]
  membershipPlans    MembershipPlan[]
  employees          Employee[] // Relation to employees
  tournaments        Tournament[]
  videos             CourtVideo[]
  
  deletedAt          DateTime? // Soft delete for Club
  @@map("Club")
}

model PlatformPlan {
  id            String   @id @default(cuid())
  name          String   @unique // "Start", "Pro"
  price         Float
  setupFee      Float    @default(0)
  features      String   // JSON array of strings
  mpBackUrl     String?  // Optional custom back url
  clubs         Club[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  name      String
  role      String
  clubId    String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?
  club      Club?      @relation(fields: [clubId], references: [id], onDelete: Cascade)
  auditLogs AuditLog[]

  @@map("User")
}

model Employee {
  id          String   @id @default(uuid())
  clubId      String
  name        String
  pin         String // PIN for local login
  permissions String // JSON string of permissions
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@map("Employee")
}

model Court {
  id          Int           @id @default(autoincrement())
  clubId      String
  name        String
  surface     String?
  isIndoor    Boolean       @default(false)
  isActive    Boolean       @default(true)
  sortOrder   Int           @default(0)
  bookings    Booking[]
  club        Club          @relation(fields: [clubId], references: [id], onDelete: Cascade)
  waitingList      WaitingList[]
  tournamentMatches TournamentMatch[]
  videos            CourtVideo[]
  hasCamera         Boolean           @default(false)
  cameraUrl         String?           // Stream or configuration
  deletedAt   DateTime?

  @@map("Court")
}

model Client {
  id           Int           @id @default(autoincrement())
  clubId       String
  name         String
  phone        String
  notes        String?
  createdAt    DateTime      @default(now())
  email        String?
  bookings     Booking[]
  club         Club          @relation(fields: [clubId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  waitingList  WaitingList[]
  deletedAt    DateTime?

  // Membership (Legacy & Advanced)
  membershipStatus    String       @default("NONE") // NONE, ACTIVE
  membershipExpiresAt DateTime?
  memberships         Membership[]

  // Tournament Data
  category            String?      // e.g. "7ma", "6ta"
  tournamentTeams1    TournamentTeam[] @relation("TeamPlayer1")
  tournamentTeams2    TournamentTeam[] @relation("TeamPlayer2")

  @@unique([clubId, phone])
  @@index([clubId, name])
  @@map("Client")
}

model PriceRule {
  id          Int       @id @default(autoincrement())
  clubId      String
  name        String?
  priority    Int       @default(0)
  startDate   DateTime?
  endDate     DateTime?
  daysOfWeek  String?
  startTime   String
  endTime     String
  price       Float
  memberPrice Float? // Optional override for members
  club        Club      @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@map("PriceRule")
}

model Booking {
  id            Int      @id @default(autoincrement())
  clubId        String
  courtId       Int
  clientId      Int?
  publicToken   String?
  recurringId   String?
  startTime     DateTime
  endTime       DateTime
  price         Float
  status        String
  paymentStatus String
  paymentMethod String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  client        Client?  @relation(fields: [clientId], references: [id])
  court         Court    @relation(fields: [courtId], references: [id])
  club          Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)

  guestName  String?
  guestPhone String?

  items        BookingItem[]
  transactions Transaction[]
  players      BookingPlayer[]

  reminderSent Boolean @default(false)

  // Matchmaking
  isOpenMatch Boolean @default(false)
  matchLevel  String?
  matchGender String?
  maxPlayers  Int     @default(4)
  description String?

  @@index([clubId, startTime])
  @@index([clubId, status])
  @@index([clubId, clientId])
  @@index([clubId, deletedAt])
  @@map("Booking")
}

model BookingItem {
  id        Int   @id @default(autoincrement())
  bookingId Int
  productId Int?
  quantity  Int   @default(1)
  unitPrice Float @default(0)

  booking Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  playerName String? // Optional: assign item to a specific player

  @@map("BookingItem")
}

model Product {
  id           Int               @id @default(autoincrement())
  clubId       String
  name         String
  category     String
  cost         Float
  price        Float
  memberPrice  Float?
  stock        Int
  minStock     Int               @default(5)
  imageUrl     String?
  isActive     Boolean           @default(true)
  deletedAt    DateTime?
  club         Club              @relation(fields: [clubId], references: [id], onDelete: Cascade)
  transactions TransactionItem[]
  bookingItems BookingItem[]

  @@map("Product")
}

model BookingPlayer {
  id            Int     @id @default(autoincrement())
  bookingId     Int
  name          String
  phone         String?
  amount        Float   @default(0)
  isPaid        Boolean @default(false)
  paymentMethod String?

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("BookingPlayer")
}

model CashRegister {
  id              Int           @id @default(autoincrement())
  clubId          String
  date            DateTime      @default(now())
  openedAt        DateTime      @default(now())
  closedAt        DateTime?
  startAmount     Float         @default(0)
  endAmountCash   Float?
  endAmountTransf Float?
  status          String
  club            Club          @relation(fields: [clubId], references: [id], onDelete: Cascade)
  transactions    Transaction[]

  @@index([clubId, date])
  @@map("CashRegister")
}

model Transaction {
  id             Int               @id @default(autoincrement())
  cashRegisterId Int
  clientId       Int?
  type           String
  category       String
  amount         Float
  method         String
  description    String?
  createdAt      DateTime          @default(now())
  bookingId      Int?
  booking        Booking?          @relation(fields: [bookingId], references: [id])
  client         Client?           @relation(fields: [clientId], references: [id])
  cashRegister   CashRegister      @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  items          TransactionItem[]

  @@map("Transaction")
}

model TransactionItem {
  id            Int         @id @default(autoincrement())
  transactionId Int
  productId     Int?
  quantity      Int
  unitPrice     Float
  subtotal      Float
  product       Product?    @relation(fields: [productId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("TransactionItem")
}

model AuditLog {
  id        String   @id @default(uuid())
  clubId    String
  userId    String?
  action    String // CREATE, UPDATE, DELETE, LOGIN
  entity    String // BOOKING, CLIENT, SETTINGS
  entityId  String?
  details   String? // JSON string con detalles del cambio
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  club Club  @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@index([clubId, createdAt])
  @@index([clubId, entity, entityId])
  @@map("AuditLog")
}

model WaitingList {
  id        Int       @id @default(autoincrement())
  clubId    String
  date      DateTime // The specific day they are waiting for
  startTime DateTime? // Optional: preferred start time
  endTime   DateTime? // Optional: preferred end time
  courtId   Int? // Optional: preferred court

  clientId Int?
  name     String // Fallback if no client ID
  phone    String // Fallback if no client ID
  notes    String?

  status    String   @default("PENDING") // PENDING, FULFILLED, CANCELED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club   Club    @relation(fields: [clubId], references: [id], onDelete: Cascade)
  client Client? @relation(fields: [clientId], references: [id])
  court  Court?  @relation(fields: [courtId], references: [id])

  @@index([clubId, date])
  @@map("WaitingList")
}

model MembershipPlan {
  id           String  @id @default(uuid())
  clubId       String
  name         String
  description  String?
  price        Float // Precio del plan en sí
  durationDays Int     @default(30) // Duración en días

  // Beneficios
  discountPercent Float @default(0) // % de descuento en turnos
  discountFixed   Float @default(0) // Monto fijo de descuento

  mpPreapprovalPlanId String? // ID del plan en MercadoPago

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  club        Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)
  memberships Membership[]

  @@map("MembershipPlan")
}

model Membership {
  id       String @id @default(uuid())
  clientId Int
  planId   String

  startDate DateTime @default(now())
  endDate   DateTime

  pricePaid Float
  status    String @default("ACTIVE") // ACTIVE, EXPIRED, CANCELLED

  mpPreapprovalId String? // ID de la suscripción recurrente en MP

  client Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  plan   MembershipPlan @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  deletedAt DateTime?

  @@index([clientId, status])
  @@map("Membership")
}

// --- TOURNAMENT MODULE ---

model Tournament {
  id          String   @id @default(uuid())
  clubId      String
  name        String
  startDate   DateTime
  endDate     DateTime?
  status      String   @default("DRAFT") // DRAFT, OPEN, IN_PROGRESS, COMPLETED
  description String?
  
  categories  TournamentCategory[]
  club        Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  @@map("Tournament")
}

model TournamentCategory {
  id           String   @id @default(uuid())
  tournamentId String
  name         String   // e.g., "7ma Categoría"
  gender       String?  // MALE, FEMALE, MIXED
  price        Float
  
  teams        TournamentTeam[]
  matches      TournamentMatch[]
  groups       TournamentGroup[]
  
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  
  @@map("TournamentCategory")
}

model TournamentTeam {
  id           String   @id @default(uuid())
  categoryId   String
  name         String
  
  // Player 1
  player1Id    Int?
  player1      Client? @relation("TeamPlayer1", fields: [player1Id], references: [id])
  player1Name  String
  player1Phone String?

  // Player 2
  player2Id    Int?
  player2      Client? @relation("TeamPlayer2", fields: [player2Id], references: [id])
  player2Name  String
  player2Phone String?

  points       Int      @default(0)
  matchesPlayed Int     @default(0)
  setsWon      Int      @default(0)
  gamesWon     Int      @default(0)
  
  category     TournamentCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  matchHome    TournamentMatch[] @relation("HomeTeam")
  matchAway    TournamentMatch[] @relation("AwayTeam")
  
  groupId      String?
  group        TournamentGroup? @relation(fields: [groupId], references: [id])

  @@map("TournamentTeam")
}

model TournamentGroup {
  id           String   @id @default(uuid())
  categoryId   String
  name         String   // "Zona A", "Grupo 1"
  teams        TournamentTeam[]
  category     TournamentCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@map("TournamentGroup")
}

model TournamentMatch {
  id           String   @id @default(uuid())
  categoryId   String
  round        String   // "Group Stage", "Quarter Final", "Final"
  
  homeTeamId   String?
  awayTeamId   String?
  homeTeam     TournamentTeam? @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam     TournamentTeam? @relation("AwayTeam", fields: [awayTeamId], references: [id])

  courtId      Int?
  startTime    DateTime?
  endTime      DateTime?
  
  homeScore    String?  // "6-4 6-2"
  awayScore    String?
  winnerId     String?
  status       String   @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED

  category     TournamentCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  court        Court?     @relation(fields: [courtId], references: [id])
  
  @@map("TournamentMatch")
}

model SystemNotification {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String   @default("INFO") // INFO, WARNING, SUCCESS, ERROR
  target    String   @default("ALL") // ALL, ADMINS, SPECIFIC_CLUBS
  isActive  Boolean  @default(true)
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("SystemNotification")
}

model CourtVideo {
  id        String   @id @default(uuid())
  clubId    String
  courtId   Int
  videoUrl  String
  thumbnail String?
  duration  Int?     // duration in seconds
  createdAt DateTime @default(now())
  
  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  court     Court    @relation(fields: [courtId], references: [id], onDelete: Cascade)
  
  @@map("CourtVideo")
}
