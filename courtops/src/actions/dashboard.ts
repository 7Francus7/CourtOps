'use server'

import prisma from '@/lib/db'
import { getCurrentClubId } from '@/lib/tenant'

export async function getDashboardAlerts() {
       const clubId = await getCurrentClubId()

       // 1. Low Stock Products (e.g. less than 5 units)
       // Assuming we might have a 'minStock' field in future, for now hardcoded to 5
       const lowStockProducts = await prisma.product.findMany({
              where: {
                     clubId,
                     stock: {
                            lte: 5
                     },
                     isActive: true
              },
              take: 5,
              select: {
                     name: true,
                     stock: true
              }
       })

       // 2. Pending Payments/Confirmations (Next 7 days)
       const todayStart = new Date()
       todayStart.setHours(0, 0, 0, 0)
       // Adjust for timezone roughly if needed, but assuming server time is reasonable base. 
       // Ideally we use club timezone.

       const futureEnd = new Date()
       futureEnd.setDate(futureEnd.getDate() + 7)
       futureEnd.setHours(23, 59, 59, 999)

       const pendingPayments = await prisma.booking.findMany({
              where: {
                     clubId,
                     startTime: {
                            gte: todayStart,
                            lte: futureEnd
                     },
                     OR: [
                            { paymentStatus: 'UNPAID', status: 'CONFIRMED' },
                            { status: 'PENDING' }
                     ]
              },
              include: {
                     client: { select: { name: true } }
              },
              orderBy: {
                     startTime: 'asc'
              },
              take: 5
       })

       return {
              lowStock: lowStockProducts,
              pendingPayments: pendingPayments
       }
}
